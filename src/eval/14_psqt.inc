// Evaluation module: piece-square tables
//
// NOTE: This file is included by src/evaluation.cpp (unity build for evaluation).
// Do not compile it as a separate translation unit.

// Index = static_cast<int>(PieceType):
// 0 = PAWN, 1 = KNIGHT, 2 = BISHOP, 3 = ROOK, 4 = QUEEN, 5 = KING, 6 = NONE

// Phase weights per piece type, aligned with Python/JS Stockfish-like values.
constexpr int STOCK_PHASE_WEIGHTS[NUM_PT] = {
    0,    // pawn
    781,  // knight
    825,  // bishop
    1276, // rook
    2538, // queen
    0     // king
};

constexpr double STOCK_PST_MG[6][64] = {
    {// pawn
     0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00,
     -0.07, 0.07, -0.03, -0.13, 0.05, -0.16, 0.10, -0.08,
     0.05, -0.12, -0.07, 0.22, -0.08, -0.05, -0.15, -0.08,
     0.13, 0.00, -0.13, 0.01, 0.11, -0.02, -0.13, 0.05,
     -0.04, -0.23, 0.06, 0.20, 0.40, 0.17, 0.04, -0.08,
     -0.09, -0.15, 0.11, 0.15, 0.32, 0.22, 0.05, -0.22,
     0.03, 0.03, 0.10, 0.19, 0.16, 0.19, 0.07, -0.05,
     0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00},
    {// knight
     -2.01, -0.83, -0.56, -0.26, -0.26, -0.56, -0.83, -2.01,
     -0.67, -0.27, 0.04, 0.37, 0.37, 0.04, -0.27, -0.67,
     -0.09, 0.22, 0.58, 0.53, 0.53, 0.58, 0.22, -0.09,
     -0.34, 0.13, 0.44, 0.51, 0.51, 0.44, 0.13, -0.34,
     -0.35, 0.08, 0.40, 0.49, 0.49, 0.40, 0.08, -0.35,
     -0.61, -0.17, 0.06, 0.12, 0.12, 0.06, -0.17, -0.61,
     -0.77, -0.41, -0.27, -0.15, -0.15, -0.27, -0.41, -0.77,
     -1.75, -0.92, -0.74, -0.73, -0.73, -0.74, -0.92, -1.75},
    {// bishop
     -0.48, 0.01, -0.14, -0.23, -0.23, -0.14, 0.01, -0.48,
     -0.17, -0.14, 0.05, 0.00, 0.00, 0.05, -0.14, -0.17,
     -0.16, 0.06, 0.01, 0.11, 0.11, 0.01, 0.06, -0.16,
     -0.12, 0.29, 0.22, 0.31, 0.31, 0.22, 0.29, -0.12,
     -0.05, 0.11, 0.25, 0.39, 0.39, 0.25, 0.11, -0.05,
     -0.07, 0.21, -0.05, 0.17, 0.17, -0.05, 0.21, -0.07,
     -0.15, 0.08, 0.19, 0.04, 0.04, 0.19, 0.08, -0.15,
     -0.53, -0.05, -0.08, -0.23, -0.23, -0.08, -0.05, -0.53},
    {// rook
     -0.17, -0.19, -0.01, 0.09, 0.09, -0.01, -0.19, -0.17,
     -0.02, 0.12, 0.16, 0.18, 0.18, 0.16, 0.12, -0.02,
     -0.22, -0.02, 0.06, 0.12, 0.12, 0.06, -0.02, -0.22,
     -0.27, -0.15, -0.04, 0.03, 0.03, -0.04, -0.15, -0.27,
     -0.13, -0.05, -0.04, -0.06, -0.06, -0.04, -0.05, -0.13,
     -0.25, -0.11, -0.01, 0.03, 0.03, -0.01, -0.11, -0.25,
     -0.21, -0.13, -0.08, 0.06, 0.06, -0.08, -0.13, -0.21,
     -0.31, -0.20, -0.14, -0.05, -0.05, -0.14, -0.20, -0.31},
    {// queen
     -0.03, -0.24, -0.08, -0.14, -0.14, -0.08, -0.24, -0.03,
     -0.20, -0.12, -0.05, -0.02, -0.02, -0.05, -0.12, -0.20,
     -0.16, 0.06, 0.02, 0.01, 0.01, 0.02, 0.06, -0.16,
     -0.14, 0.03, 0.13, 0.17, 0.17, 0.13, 0.03, -0.14,
     -0.10, 0.11, 0.15, 0.13, 0.13, 0.15, 0.11, -0.10,
     -0.12, 0.11, 0.09, 0.17, 0.17, 0.09, 0.11, -0.12,
     -0.13, -0.04, 0.02, 0.05, 0.05, 0.02, -0.04, -0.13,
     -0.32, -0.29, -0.12, -0.08, -0.08, -0.12, -0.29, -0.32},
    {// king
     0.17, 0.54, 0.36, 0.13, 0.13, 0.36, 0.54, 0.17,
     0.24, 0.65, 0.45, 0.19, 0.19, 0.45, 0.65, 0.24,
     -0.09, 0.26, 0.60, 0.71, 0.71, 0.60, 0.26, -0.09,
     -0.13, 0.09, 0.29, 0.62, 0.62, 0.29, 0.09, -0.13,
     -0.18, -0.03, 0.11, 0.39, 0.39, 0.11, -0.03, -0.18,
     -0.27, -0.11, 0.07, 0.40, 0.40, 0.07, -0.11, -0.27,
     -0.53, -0.21, -0.07, 0.16, 0.16, -0.07, -0.21, -0.53,
     -0.69, -0.52, -0.43, -0.34, -0.34, -0.43, -0.52, -0.69}};

constexpr double STOCK_PST_EG[6][64] = {
    {// pawn
     0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00,
     0.00, -0.11, 0.12, 0.21, 0.25, 0.19, 0.04, 0.07,
     0.28, 0.20, 0.21, 0.28, 0.30, 0.07, 0.06, 0.13,
     0.10, 0.05, 0.04, -0.05, -0.05, -0.05, 0.14, 0.09,
     0.06, -0.02, -0.08, -0.04, -0.13, -0.12, -0.10, -0.09,
     -0.10, -0.10, -0.10, 0.04, 0.04, 0.03, -0.06, -0.04,
     -0.10, -0.06, 0.10, 0.00, 0.14, 0.07, -0.05, -0.19,
     0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00},
    {// knight
     -1.00, -0.88, -0.56, -0.17, -0.17, -0.56, -0.88, -1.00,
     -0.69, -0.50, -0.51, 0.12, 0.12, -0.51, -0.50, -0.69,
     -0.51, -0.44, -0.16, 0.17, 0.17, -0.16, -0.44, -0.51,
     -0.45, -0.16, 0.09, 0.39, 0.39, 0.09, -0.16, -0.45,
     -0.35, -0.02, 0.13, 0.28, 0.28, 0.13, -0.02, -0.35,
     -0.43, -0.04, 0.20, 0.22, 0.22, 0.20, -0.04, -0.43,
     -0.36, -0.17, 0.04, 0.15, 0.15, 0.04, -0.17, -0.36,
     -0.93, -0.58, -0.37, -0.29, -0.29, -0.37, -0.58, -0.93},
    {// bishop
     -0.37, -0.02, -0.16, -0.40, -0.40, -0.16, -0.02, -0.37,
     -0.22, 0.00, -0.20, -0.10, -0.10, -0.20, 0.00, -0.22,
     -0.18, 0.03, 0.12, 0.05, 0.05, 0.12, 0.03, -0.18,
     -0.16, 0.11, 0.18, 0.25, 0.25, 0.18, 0.11, -0.16,
     -0.13, 0.10, 0.16, 0.29, 0.29, 0.16, 0.10, -0.13,
     -0.18, 0.01, 0.14, 0.17, 0.17, 0.14, 0.01, -0.18,
     -0.45, -0.14, 0.03, 0.13, 0.13, 0.03, -0.14, -0.45,
     -0.46, -0.16, -0.11, -0.24, -0.24, -0.11, -0.16, -0.46},
    {// rook
     -0.30, -0.45, -0.39, -0.34, -0.34, -0.39, -0.45, -0.30,
     -0.25, -0.20, -0.22, -0.21, -0.21, -0.22, -0.20, -0.25,
     -0.19, -0.12, -0.16, -0.14, -0.14, -0.16, -0.12, -0.19,
     -0.10, -0.05, -0.07, -0.05, -0.05, -0.07, -0.05, -0.10,
     -0.09, -0.04, -0.05, -0.06, -0.06, -0.05, -0.04, -0.09,
     -0.06, 0.00, -0.03, -0.05, -0.05, -0.03, 0.00, -0.06,
     -0.03, 0.02, -0.01, -0.05, -0.05, -0.01, 0.02, -0.03,
     -0.09, -0.05, -0.17, -0.20, -0.20, -0.17, -0.05, -0.09},
    {// queen
     -0.28, -0.06, -0.14, -0.11, -0.11, -0.14, -0.06, -0.28,
     -0.20, -0.08, 0.00, -0.02, -0.02, 0.00, -0.08, -0.20,
     -0.26, -0.08, 0.00, 0.15, 0.15, 0.00, -0.08, -0.26,
     -0.16, -0.14, 0.02, 0.14, 0.14, 0.02, -0.14, -0.16,
     -0.14, -0.01, 0.11, 0.13, 0.13, 0.11, -0.01, -0.14,
     -0.22, -0.10, -0.05, 0.03, 0.03, -0.05, -0.10, -0.22,
     -0.23, -0.19, -0.09, -0.06, -0.06, -0.09, -0.19, -0.23,
     -0.32, -0.30, -0.24, -0.12, -0.12, -0.24, -0.30, -0.32},
    {// king
     0.11, 0.59, 0.73, 0.78, 0.78, 0.73, 0.59, 0.11,
     0.47, 1.21, 1.16, 1.31, 1.31, 1.16, 1.21, 0.47,
     0.92, 1.72, 1.84, 1.91, 1.91, 1.84, 1.72, 0.92,
     0.96, 1.66, 1.99, 1.99, 1.99, 1.99, 1.66, 0.96,
     1.03, 1.56, 1.72, 1.72, 1.72, 1.72, 1.56, 1.03,
     0.88, 1.30, 1.69, 1.75, 1.75, 1.69, 1.30, 0.88,
     0.53, 1.00, 1.33, 1.35, 1.35, 1.33, 1.00, 0.53,
     0.01, 0.45, 0.85, 0.76, 0.76, 0.85, 0.45, 0.01}};

// Core stock PST function: White POV, in pawns.
double piece_square_term_white_minus_black_stock(const Board &board)
{
    double mg_score = 0.0;
    double eg_score = 0.0;
    int game_phase_score = 0;

    // For both sides
    for (Color c : {Color::WHITE, Color::BLACK})
    {
        const bool is_white = (c == Color::WHITE);

        // For all piece types PAWN..KING
        for (PieceType pt : {PieceType::PAWN,
                             PieceType::KNIGHT,
                             PieceType::BISHOP,
                             PieceType::ROOK,
                             PieceType::QUEEN,
                             PieceType::KING})
        {

            int idx = static_cast<int>(pt); // 0..5, matches rows of STOCK_PST_*

            Bitboard bb = board.pieces(pt, c);
            while (bb)
            {
                const std::uint8_t sq_index = bb.pop(); // 0..63

                const int file = sq_index & 7;  // 0..7
                const int rank = sq_index >> 3; // 0..7

                const int rank_from_white = is_white ? rank : (7 - rank);
                const int table_index = rank_from_white * 8 + file;

                const double mg = STOCK_PST_MG[idx][table_index];
                const double eg = STOCK_PST_EG[idx][table_index];

                if (is_white)
                {
                    mg_score += mg;
                    eg_score += eg;
                }
                else
                {
                    mg_score -= mg;
                    eg_score -= eg;
                }

                game_phase_score += STOCK_PHASE_WEIGHTS[idx];
            }
        }
    }

    const int gp = game_phase_score;

    if (gp >= STOCK_OPENING_PHASE_SCORE)
    {
        return mg_score; // pure opening
    }
    if (gp <= STOCK_ENDGAME_PHASE_SCORE)
    {
        return eg_score; // pure endgame
    }

    return (mg_score * gp +
            eg_score * (STOCK_OPENING_PHASE_SCORE - gp)) /
           static_cast<double>(STOCK_OPENING_PHASE_SCORE);
}

double piece_square_term_white_minus_black_custom(const Board & /*board*/,
                                                  int /*phase_0_256*/)
{
    return 0.0;
}
